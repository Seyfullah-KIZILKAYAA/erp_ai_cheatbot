{% load static %}
{% load custom_filters %}
<div class="searchable-checkbox-container">
    <div class="search-box-wrapper">
        <input type="text" class="searchable-checkbox-search" placeholder="Tablo ara (√∂rn: account, sale, product)..."
            data-target="{{ attrs.id }}">
        <span class="search-icon">üîç</span>
    </div>

    <div class="checkbox-list-wrapper" id="{{ attrs.id }}_wrapper">
        <div class="checkbox-count">
            <span class="selected-count">0</span> / <span class="total-count">{{ widget.choices|length }}</span> se√ßili
        </div>

        <div class="checkbox-list">
            {% for group, options, index in widget.optgroups %}
            {% for option in options %}
            <label class="checkbox-item" data-searchable="{{ option.label|lower }}">
                <input type="checkbox" name="{{ widget.name }}" value="{{ option.value }}" {{ option.attrs|safe }}
                    class="checkbox-input">
                <span class="checkbox-label">
                    {% with parts=option.label|split:" | " %}
                    <span class="model-name">{{ parts.0 }}</span>
                    {% if parts|length > 1 %}
                    <span class="model-description">{{ parts.1 }}</span>
                    {% endif %}
                    {% endwith %}
                </span>
            </label>
            {% endfor %}
            {% endfor %}
        </div>
    </div>

    <div class="checkbox-actions">
        <button type="button" class="select-all-btn" data-target="{{ attrs.id }}">T√ºm√ºn√º Se√ß</button>
        <button type="button" class="deselect-all-btn" data-target="{{ attrs.id }}">T√ºm√ºn√º Kaldƒ±r</button>
    </div>
</div>

<style>
    .searchable-checkbox-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: #f9f9f9;
        width: 100%;
        min-width: 600px;
    }

    .search-box-wrapper {
        position: relative;
        margin-bottom: 15px;
    }

    .searchable-checkbox-search {
        width: 100%;
        padding: 10px 40px 10px 15px;
        border: 2px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .searchable-checkbox-search:focus {
        outline: none;
        border-color: #417690;
    }

    .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
    }

    .checkbox-count {
        padding: 8px 12px;
        background: #e8f4f8;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 13px;
        color: #333;
    }

    .selected-count {
        font-weight: bold;
        color: #417690;
    }

    .checkbox-list-wrapper {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
    }

    .checkbox-list {
        max-height: 400px;
        overflow-y: auto;
        padding: 5px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        margin: 3px 0;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .checkbox-item:hover {
        background-color: #f0f8ff;
    }

    .checkbox-item.hidden {
        display: none;
    }

    .checkbox-input {
        margin-right: 10px;
        cursor: pointer;
        width: 18px;
        height: 18px;
    }

    .checkbox-label {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .model-name {
        font-weight: 600;
        color: #333;
        font-size: 13px;
        font-family: monospace;
    }

    .model-description {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
    }

    .checkbox-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }

    .select-all-btn,
    .deselect-all-btn {
        padding: 8px 16px;
        border: 1px solid #417690;
        background: white;
        color: #417690;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
    }

    .select-all-btn:hover,
    .deselect-all-btn:hover {
        background: #417690;
        color: white;
    }
</style>

<script>
    (function () {
        document.addEventListener('DOMContentLoaded', function () {
            // Arama fonksiyonu
            document.querySelectorAll('.searchable-checkbox-search').forEach(function (searchInput) {
                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    const targetId = this.getAttribute('data-target');
                    const wrapper = document.getElementById(targetId + '_wrapper');
                    const items = wrapper.querySelectorAll('.checkbox-item');

                    items.forEach(function (item) {
                        const searchable = item.getAttribute('data-searchable');
                        if (searchable.includes(searchTerm)) {
                            item.classList.remove('hidden');
                        } else {
                            item.classList.add('hidden');
                        }
                    });
                });
            });

            // Saya√ß g√ºncelleme
            function updateCount(wrapper) {
                const total = wrapper.querySelectorAll('.checkbox-input').length;
                const selected = wrapper.querySelectorAll('.checkbox-input:checked').length;
                wrapper.querySelector('.selected-count').textContent = selected;
                wrapper.querySelector('.total-count').textContent = total;
            }

            // Checkbox deƒüi≈üikliklerini dinle
            document.querySelectorAll('.checkbox-input').forEach(function (checkbox) {
                checkbox.addEventListener('change', function () {
                    const wrapper = this.closest('.checkbox-list-wrapper');
                    updateCount(wrapper);
                });
            });

            // T√ºm√ºn√º se√ß/kaldƒ±r butonlarƒ±
            document.querySelectorAll('.select-all-btn').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    const targetId = this.getAttribute('data-target');
                    const wrapper = document.getElementById(targetId + '_wrapper');
                    wrapper.querySelectorAll('.checkbox-input').forEach(function (cb) {
                        if (!cb.closest('.checkbox-item').classList.contains('hidden')) {
                            cb.checked = true;
                        }
                    });
                    updateCount(wrapper);
                });
            });

            document.querySelectorAll('.deselect-all-btn').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    const targetId = this.getAttribute('data-target');
                    const wrapper = document.getElementById(targetId + '_wrapper');
                    wrapper.querySelectorAll('.checkbox-input').forEach(function (cb) {
                        cb.checked = false;
                    });
                    updateCount(wrapper);
                });
            });

            // ƒ∞lk y√ºklemede saya√ßlarƒ± g√ºncelle
            document.querySelectorAll('.checkbox-list-wrapper').forEach(updateCount);
        });
    })();
</script>